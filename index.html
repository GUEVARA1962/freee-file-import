<script>
    // ===== 定数 =====
    // ▼▼▼▼▼ n8nのWebhookノードのPRODUCTION URLを貼り付けてください ▼▼▼▼▼
    const webhookUrl = 'YOUR_N8N_WEBHOOK_PRODUCTION_URL';
    // ▲▲▲▲▲ n8nのWebhookノードのPRODUCTION URLを貼り付けてください ▲▲▲▲▲

    // ===== DOM要素の取得 =====
    const mainUI = document.getElementById('main-ui');
    const subUICash = document.getElementById('sub-ui-cash');
    const subUIBank = document.getElementById('sub-ui-bank');
    const subUICard = document.getElementById('sub-ui-card');
    const backButtons = document.querySelectorAll('.btn-back');

    // ===== 表示切り替え関数 =====
    const showView = (viewToShow) => {
        [mainUI, subUICash, subUIBank, subUICard].forEach(ui => ui.classList.add('hidden'));
        viewToShow.classList.remove('hidden');
        viewToShow.classList.add('flex');
    };

    // ===== ★★★ 新しいファイル送信関数（複数ファイル対応） ★★★ =====
    const handleFileUploads = async (files, dropArea) => {
        if (!webhookUrl || webhookUrl === 'YOUR_N8N_WEBHOOK_PRODUCTION_URL') {
            alert('n8nのWebhook URLが設定されていません。scriptタグ内のwebhookUrlを編集してください。');
            return;
        }

        const p = dropArea.querySelector('p');
        const button = dropArea.querySelector('button');
        const totalFiles = files.length;
        let successCount = 0;
        let errorCount = 0;

        // ローディング表示に切り替え
        p.textContent = `処理中... (0/${totalFiles} ファイル完了)`;
        button.disabled = true;
        button.textContent = '処理中...';
        dropArea.classList.add('opacity-50', 'cursor-not-allowed');

        // 各ファイルを順番に処理
        for (let i = 0; i < totalFiles; i++) {
            const file = files[i];
            p.textContent = `処理中... (${i}/${totalFiles}) ファイル名: ${file.name}`;

            try {
                // FileReaderを使ってファイルをBase64文字列に変換
                const base64String = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = (error) => reject(error);
                });

                // n8nへJSON形式で送信
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ base64Image: base64String, fileName: file.name }),
                });

                if (response.ok) {
                    successCount++;
                } else {
                    errorCount++;
                }
            } catch (error) {
                console.error('Upload error:', error);
                errorCount++;
            }
            p.textContent = `処理中... (${i + 1}/${totalFiles} ファイル完了)`;
        }

        // 最終結果を表示
        if (errorCount > 0) {
            p.textContent = `❌ 処理完了: ${successCount}件成功, ${errorCount}件失敗。`;
        } else {
            p.textContent = `✅ 全${successCount}件の処理が完了しました！`;
        }
        button.textContent = '別のファイルを選択';
        button.disabled = false;
        dropArea.classList.remove('opacity-50', 'cursor-not-allowed');
    };

    // ===== イベントリスナーの設定 =====
    document.getElementById('btn-cash').addEventListener('click', () => showView(subUICash));
    document.getElementById('btn-bank').addEventListener('click', () => showView(subUIBank));
    document.getElementById('btn-card').addEventListener('click', () => showView(subUICard));

    backButtons.forEach(button => button.addEventListener('click', () => showView(mainUI)));

    document.querySelectorAll('div[class*="border-dashed"]').forEach(dropArea => {
        const input = dropArea.querySelector('input[type="file"]');
        const button = dropArea.querySelector('button');
        button.addEventListener('click', () => input.click());
        
        const onFilesSelected = (files) => {
            if (files.length > 0) handleFileUploads(files, dropArea);
        };

        input.addEventListener('change', (e) => onFilesSelected(e.target.files));
        dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.classList.add('drag-over'); });
        dropArea.addEventListener('dragleave', (e) => { e.preventDefault(); dropArea.classList.remove('drag-over'); });
        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('drag-over');
            onFilesSelected(e.dataTransfer.files);
        });
    });
</script>